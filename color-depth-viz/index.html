<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Color Depth Visualizer (Static)</title>
  <style>
    :root { --bg:#f3f6fa; --panel:#ffffff; --txt:#0f172a; --muted:#475569; --line:#dbe3ee; --accent:#0b84ff; }
    body { margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, sans-serif; background:linear-gradient(180deg,#eef4ff,#f8fbff); color:var(--txt); }
    .wrap { max-width: 1250px; margin: 18px auto; padding: 14px; }
    .bar { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    select, button, input[type=file] { border:1px solid #c8d5e6; border-radius:8px; padding:8px; background:#fff; }
    button { background:var(--accent); color:#fff; border-color:var(--accent); cursor:pointer; }
    .status { font-size:13px; color:var(--muted); }
    .grid { margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .card { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px; }
    .title { font-weight:600; margin-bottom:8px; }
    canvas { width:100%; height:auto; border:1px solid #d4deeb; border-radius:10px; background:#fff; }
    @media (max-width: 900px) { .grid { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp" />
      <label>Preset</label>
      <select id="presetImage">
        <option value="cat_clouds.png" selected>cat_clouds.png</option>
        <option value="ocean.jpeg">ocean.jpeg</option>
      </select>
      <label>Left</label>
      <select id="leftMode">
        <option>High Color (16-bit RGB565)</option>
        <option selected>True Color (24-bit RGB888)</option>
        <option>Deep Color (10-bit RGB101010)</option>
      </select>
      <label>Right</label>
      <select id="rightMode">
        <option selected>High Color (16-bit RGB565)</option>
        <option>True Color (24-bit RGB888)</option>
        <option>Deep Color (10-bit RGB101010)</option>
      </select>
      <button id="applyBtn">Apply</button>
      <span id="status" class="status">Loading default image...</span>
    </div>

    <div class="grid">
      <div class="card">
        <div id="leftTitle" class="title"></div>
        <canvas id="leftCanvas"></canvas>
      </div>
      <div class="card">
        <div id="rightTitle" class="title"></div>
        <canvas id="rightCanvas"></canvas>
      </div>
    </div>
  </div>

<script>
const MODES = {
  "High Color (16-bit RGB565)": [5,6,5],
  "True Color (24-bit RGB888)": [8,8,8],
  "Deep Color (10-bit RGB101010)": [10,10,10],
};

const fileInput = document.getElementById('fileInput');
const presetImage = document.getElementById('presetImage');
const leftMode = document.getElementById('leftMode');
const rightMode = document.getElementById('rightMode');
const applyBtn = document.getElementById('applyBtn');
const leftCanvas = document.getElementById('leftCanvas');
const rightCanvas = document.getElementById('rightCanvas');
const leftTitle = document.getElementById('leftTitle');
const rightTitle = document.getElementById('rightTitle');
const statusEl = document.getElementById('status');

let sourceImageData = null;

function setStatus(msg) { statusEl.textContent = msg; }

function srgbToLin(s) {
  if (s <= 0.04045) return s / 12.92;
  return Math.pow((s + 0.055) / 1.055, 2.4);
}
function linToSrgb(l) {
  if (l <= 0.0031308) return 12.92 * l;
  return 1.055 * Math.pow(l, 1/2.4) - 0.055;
}
function buildLUT(bits) {
  const levels = (1 << bits) - 1;
  const lut = new Uint8Array(256);
  for (let i=0;i<256;i++) {
    const lin = srgbToLin(i/255);
    const q = Math.round(lin * levels) / levels;
    lut[i] = Math.max(0, Math.min(255, Math.round(linToSrgb(q)*255)));
  }
  return lut;
}

const modeLUT = {
  "High Color (16-bit RGB565)": [buildLUT(5), buildLUT(6), buildLUT(5)],
  "True Color (24-bit RGB888)": [buildLUT(8), buildLUT(8), buildLUT(8)],
  "Deep Color (10-bit RGB101010)": [buildLUT(10), buildLUT(10), buildLUT(10)],
};

function fitSize(w,h,maxW=560,maxH=420){
  const s = Math.min(maxW/w, maxH/h, 1);
  return [Math.max(1, Math.round(w*s)), Math.max(1, Math.round(h*s))];
}

function decodeToImageData(img) {
  const [w,h] = fitSize(img.naturalWidth, img.naturalHeight);
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d', { willReadFrequently: true });
  ctx.drawImage(img, 0, 0, w, h);
  return ctx.getImageData(0, 0, w, h);
}

function buildFallbackImageData() {
  const w = 560, h = 360;
  const c = document.createElement('canvas');
  c.width = w; c.height = h;
  const ctx = c.getContext('2d', { willReadFrequently: true });

  const g = ctx.createLinearGradient(0, 0, w, h);
  g.addColorStop(0, '#0b4db8');
  g.addColorStop(0.55, '#1e88e5');
  g.addColorStop(1, '#e3f2fd');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, w, h);

  for (let i = 0; i < 6; i++) {
    const x = 40 + i * 90;
    const y = 55 + (i % 2) * 35;
    const r = 26 + (i % 3) * 8;
    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.arc(x + r, y + 8, r * 0.8, 0, Math.PI * 2);
    ctx.arc(x - r, y + 8, r * 0.8, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(255,255,255,0.86)';
    ctx.fill();
  }

  ctx.fillStyle = 'rgba(255,255,255,0.92)';
  ctx.fillRect(0, h - 62, w, 62);
  ctx.fillStyle = '#0f172a';
  ctx.font = '600 22px ui-sans-serif, -apple-system, Segoe UI, Roboto, sans-serif';
  ctx.fillText('Fallback image loaded', 18, h - 26);
  ctx.font = '16px ui-sans-serif, -apple-system, Segoe UI, Roboto, sans-serif';
  ctx.fillText('Choose a file or run local server for preset files.', 18, h - 8);

  return ctx.getImageData(0, 0, w, h);
}

function renderMode(modeName, canvas, titleEl) {
  if (!sourceImageData) return;
  const [rl, gl, bl] = modeLUT[modeName];
  titleEl.textContent = modeName;

  canvas.width = sourceImageData.width;
  canvas.height = sourceImageData.height;

  const out = new ImageData(sourceImageData.width, sourceImageData.height);
  const src = sourceImageData.data;
  const dst = out.data;

  for (let i = 0; i < src.length; i += 4) {
    dst[i] = rl[src[i]];
    dst[i+1] = gl[src[i+1]];
    dst[i+2] = bl[src[i+2]];
    dst[i+3] = src[i+3];
  }

  canvas.getContext('2d').putImageData(out, 0, 0);
}

function applyModes() {
  if (!sourceImageData) return;
  setStatus('Applying modes...');
  requestAnimationFrame(() => {
    renderMode(leftMode.value, leftCanvas, leftTitle);
    renderMode(rightMode.value, rightCanvas, rightTitle);
    setStatus(`Ready | Left=${leftMode.value} | Right=${rightMode.value}`);
  });
}

function loadFromFile(file) {
  if (!file) return;
  setStatus(`Loading ${file.name}...`);
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.onload = () => {
      sourceImageData = decodeToImageData(img);
      applyModes();
    };
    img.onerror = () => setStatus('Failed to decode selected image.');
    img.src = reader.result;
  };
  reader.onerror = () => setStatus('Failed to read selected image.');
  reader.readAsDataURL(file);
}

function loadPreset(path) {
  setStatus(`Loading ${path}...`);
  const img = new Image();
  img.onload = () => {
    sourceImageData = decodeToImageData(img);
    applyModes();
  };
  img.onerror = () => {
    sourceImageData = buildFallbackImageData();
    applyModes();
    if (window.location.protocol === 'file:') {
      setStatus('Preset blocked on file://. Use Choose File or run: python3 -m http.server 8080');
    } else {
      setStatus(`Preset not found: ${path}`);
    }
  };
  img.src = path;
}

fileInput.addEventListener('change', () => loadFromFile(fileInput.files[0]));
presetImage.addEventListener('change', () => loadPreset(presetImage.value));
leftMode.addEventListener('change', applyModes);
rightMode.addEventListener('change', applyModes);
applyBtn.addEventListener('click', applyModes);

loadPreset(presetImage.value);
</script>
</body>
</html>
